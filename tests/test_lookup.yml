---

- name: Test rbw_structured Lookup Plugin
  hosts: localhost
  gather_facts: false
  vars:
    json_entry: ""            # Note mit JSON
    login_entry: ""           # Login mit username/password
    raw_note: ""                                   # Note mit einfachem Text
    broken_json_entry: ""     # Note mit ungültigem JSON
  tasks:
    - name: "Test: String lesen"
      debug:
        msg: "Raw note: {{ lookup('bodsch.core.rbw', raw_note) }}"

    - name: "Test: Login-Feld (username)"
      debug:
        msg: "Username: {{ lookup('bodsch.core.rbw', login_entry, field='username') }}"

    - name: "Test: Login-Feld (password)"
      debug:
        msg: "Password: {{ lookup('bodsch.core.rbw', login_entry, field='password') }}"

    - name: "Test: JSON parsen"
      set_fact:
        json_data: "{{ lookup('bodsch.core.rbw', json_entry, parse_json=True) }}"

    - name: "Ausgabe: JSON-Felder"
      debug:
        msg:
          - "Token: {{ json_data.token | default('nicht gesetzt') }}"
          - "URL: {{ json_data.url | default('nicht gesetzt') }}"

    - name: "Test: Defektes JSON → Fallback zu leerem Dict"
      set_fact:
        broken: "{{ lookup('bodsch.core.rbw', broken_json_entry, parse_json=True) }}"

    - name: "Ausgabe: Fallback-JSON"
      debug:
        var: broken

    - name: "Test: Striktes JSON → Fehler"
      block:
        - set_fact:
            broken_strict: "{{ lookup('bodsch.core.rbw', broken_json_entry, parse_json=True, strict_json=True) }}"
        - debug:
            var: broken_strict
      rescue:
        - debug:
            msg: "Wie erwartet: JSON ungültig – Fehler behandelt."
